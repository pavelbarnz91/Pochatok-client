(()=>{"use strict";const e={url:"https://github.com/pavelbarnz91/Pochatok-server:9090",getModalWindow:function(e){return fetch(this.url+e).then((async e=>await e.text()))},regNewUser:function(e,i){return fetch(this.url+e,{method:"POST",body:i}).then((async e=>await e.json()))},login:function(e,i){return fetch(this.url+e,{method:"POST",body:i}).then((async e=>await e.json()))}},i={showTooltip:e=>{const i=document.querySelector(".tooltip");i&&i.remove();const s=document.createElement("DIV");s.classList.add("tooltip"),s.textContent=e,document.body.appendChild(s);const t=document.body.getBoundingClientRect().width;s.style.right=t/2-s.offsetWidth/2+"px",s.style.top="0px"},removeTooltip:()=>{const e=document.querySelector(".tooltip");e&&e.remove()}};class s{constructor(e){this.appWindow=e,this.userAvatar=null}async registration(s){if(!this.regValidity(s)){i.removeTooltip();const t=new FormData(s);null===this.userAvatar?t.set("avatar","null"):t.set("avatar",this.userAvatar);const a=await e.regNewUser("/registration",t);return a.status.result?(i.removeTooltip(),document.querySelector('[data-registartion="window-wrapper"]').remove(),a):(i.showTooltip(a.status.text),null)}}async login(s){if(!this.regValidity(s)){i.removeTooltip();const t=new FormData(s),a=await e.login("/login",t);return a.status?(i.removeTooltip(),document.querySelector('[data-login="window-wrapper"]').remove(),a.user):(i.showTooltip(a.text),null)}}regValidity(e){const s={nickname:{valueMissing:"ĞŸĞµÑ€Ğ´ÑÑ‚Ğ°Ğ²ÑŒÑ‚ĞµÑÑŒ Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°!"},age:{valueMissing:"Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ°Ğ¼ Ğ»ĞµÑ‚?"},city:{valueMissing:"Ğ˜Ğ· ĞºĞ°ĞºĞ¾Ğ³Ğ¾ Ğ²Ñ‹ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°?"},email:{valueMissing:"ĞĞ°Ğ¼ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ²Ğ°ÑˆĞ° Ğ¿Ğ¾Ñ‡Ñ‚Ğ°!",typeMismatch:'ĞŸĞ¾Ñ‡Ñ‚Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» "@"'},password:{tooShort:"ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²!",valueMissing:"ĞŸÑ€Ğ¸Ğ´ÑƒĞ¼Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ!"}};return Array.from(e.elements).some((e=>Object.keys(ValidityState.prototype).some((t=>{if(e.name&&"valid"!==t)return e.validity[t]?(i.showTooltip(s[e.name][t]),!0):void 0}))))}regWindowAvatar(){this.appWindow.querySelector('[data-registartion="input-avatar"]').addEventListener("change",(e=>{this.userAvatar=e.target.files[0];this.appWindow.querySelector('[data-registartion="avatar-image"]').style.backgroundImage=`url(${URL.createObjectURL(this.userAvatar)})`,URL.revokeObjectURL(this.userAvatar),e.target.value=""}))}}class t{static setEmojiWindow(){return'<div class="emoji-window">\n        <div class="emoji-window__item">ğŸ˜„</div>\n        <div class="emoji-window__item">ğŸ˜†</div>\n        <div class="emoji-window__item">ğŸ˜…</div>\n        <div class="emoji-window__item">ğŸ¤£</div>\n        <div class="emoji-window__item">ğŸ˜‚</div>\n        <div class="emoji-window__item">ğŸ™‚</div>\n        <div class="emoji-window__item">ğŸ™ƒ</div>\n        <div class="emoji-window__item">ğŸ˜‰</div>\n        <div class="emoji-window__item">ğŸ˜Š</div>\n        <div class="emoji-window__item">ğŸ˜‡</div>\n        <div class="emoji-window__item">ğŸ¥°</div>\n        <div class="emoji-window__item">ğŸ˜</div>\n        <div class="emoji-window__item">ğŸ˜˜</div>\n        <div class="emoji-window__item">ğŸ˜š</div>\n        <div class="emoji-window__item">ğŸ˜‹</div>\n        <div class="emoji-window__item">ğŸ˜›</div>\n        <div class="emoji-window__item">ğŸ˜œ</div>\n        <div class="emoji-window__item">ğŸ¤ª</div>\n        <div class="emoji-window__item">ğŸ˜</div>\n        <div class="emoji-window__item">ğŸ¤¨</div>\n        <div class="emoji-window__item">ğŸ˜</div>\n        <div class="emoji-window__item">ğŸ˜‘</div>\n        <div class="emoji-window__item">ğŸ˜</div>\n        <div class="emoji-window__item">ğŸ˜’</div>\n        <div class="emoji-window__item">ğŸ™„</div>\n        <div class="emoji-window__item">ğŸ˜</div>\n        <div class="emoji-window__item">ğŸ¥³</div>\n        <div class="emoji-window__item">ğŸ¤¯</div>\n        <div class="emoji-window__item">ğŸ˜µ</div>\n        <div class="emoji-window__item">ğŸ¥´</div>\n        <div class="emoji-window__item">ğŸ¤§</div>\n        <div class="emoji-window__item">ğŸ¤®</div>\n        <div class="emoji-window__item">ğŸ¤¢</div>\n        <div class="emoji-window__item">ğŸ¤’</div>\n        <div class="emoji-window__item">ğŸ˜´</div>\n        <div class="emoji-window__item">ğŸ¤¤</div>\n        <div class="emoji-window__item">ğŸ˜ª</div>\n        <div class="emoji-window__item">ğŸ˜”</div>\n        <div class="emoji-window__item">ğŸ˜Ÿ</div>\n        <div class="emoji-window__item">â˜¹ï¸</div>\n        <div class="emoji-window__item">ğŸ˜®</div>\n        <div class="emoji-window__item">ğŸ˜¯</div>\n        <div class="emoji-window__item">ğŸ˜²</div>\n        <div class="emoji-window__item">ğŸ˜³</div>\n        <div class="emoji-window__item">ğŸ˜°</div>\n        <div class="emoji-window__item">ğŸ˜¥</div>\n        <div class="emoji-window__item">ğŸ˜­</div>\n        <div class="emoji-window__item">ğŸ˜±</div>\n        <div class="emoji-window__item">ğŸ˜–</div>\n        <div class="emoji-window__item">ğŸ˜</div>\n        <div class="emoji-window__item">ğŸ˜“</div>\n        <div class="emoji-window__item">ğŸ˜¤</div>\n        <div class="emoji-window__item">ğŸ˜¡</div>\n        <div class="emoji-window__item">ğŸ¤¬</div>\n        <div class="emoji-window__item">ğŸ˜ˆ</div>\n        <div class="emoji-window__item">ğŸ‘¿</div>\n        <div class="emoji-window__item">ğŸ’©</div>\n        <div class="emoji-window__item">ğŸ’‹</div>\n        <div class="emoji-window__item">ğŸ’¯</div>\n        <div class="emoji-window__item">ğŸ‘‹</div>\n        <div class="emoji-window__item">ğŸ‘ˆ</div>\n        <div class="emoji-window__item">ğŸ‘‰</div>\n        <div class="emoji-window__item">ğŸ‘†</div>\n        <div class="emoji-window__item">ğŸ–•</div>\n        <div class="emoji-window__item">ğŸ‘‡</div>\n        <div class="emoji-window__item">â˜ï¸</div>\n        <div class="emoji-window__item">ğŸ‘</div>\n        <div class="emoji-window__item">ğŸ’ª</div>\n        <div class="emoji-window__item">ğŸ™</div>\n        <div class="emoji-window__item">ğŸ’–</div>\n        <div class="emoji-window__item">ğŸ’—</div>\n        <div class="emoji-window__item">ğŸ’”</div>\n        <div class="emoji-window__item">â¤ï¸</div>\n    </div>'}static setMessageHtml(e){return`<div class="message">\n        <div class="message__user-avatar">\n            <img class="user-avatar__image" src="${e.userAvatar}">\n        </div>\n        <div class="message__content">\n            <div class="message__header">\n                <span class="header__name">${e.userNickname}</span>\n                <span class="header__date">${e.date}</span>\n            </div>\n            <div class="message__text-box">\n                <span class="message__text">${e.text}</span>\n            </div>\n        </div>\n    </div>`}static setYouMessageHtml(e){return`<div class="message you">\n        <div class="message__user-avatar">\n            <img class="user-avatar__image" src="${e.userAvatar}">\n        </div>\n        <div class="message__content">\n            <div class="message__header">\n                <span class="header__name you-name">${e.userNickname}</span>\n                <span class="header__date">${e.date}</span>\n            </div>\n            <div class="message__text-box">\n                <span class="message__text">${e.text}</span>\n            </div>\n        </div>\n    </div>`}}class a{constructor(e){this.appWindow=e,this.chat=this.appWindow.querySelector('[data-chat="chat-box"]'),this.header=this.appWindow.querySelector('[data-app-hedaer="header"]'),this.usersOnlineBtn=this.appWindow.querySelector('[data-users-online="show-list"]'),this.device=document.body.getBoundingClientRect(),this.userList()}userList(){if(this.device.width<400){this.appWindow.querySelector('[data-chat="user-list-pc"]').remove();const e='\n                    <div class="chat__user-list hidden" data-chat="user-list-pc">\n                        <div class="user-list__header">\n                            <span class="user-list__header-title">Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ² ÑĞµÑ‚Ğ¸</span>\n                        </div>\n\n                        <div class="user-list__content-wrapper" data-user-list="users-online-wrapper">\n\n                            <div class="user-list__content" data-user-list="users-online"></div>\n                        </div>\n                    </div>';this.chat.insertAdjacentHTML("afterbegin",e),this.usersOnlineList=this.appWindow.querySelector('[data-chat="user-list-pc"]'),this.usersOnlineBtn.addEventListener("click",(()=>{this.usersOnlineList.classList.toggle("hidden")}))}}avatar(e){this.user=e,this.userAvatar=this.appWindow.querySelector('[data-app-header="avatar"]'),console.log(e),this.userAvatar.style.backgroundImage=`url(${this.user.avatar})`}}class n{constructor(e){this.appWindow=e,this.MobileAdaptive=new a(this.appWindow),this.userInput=this.appWindow.querySelector('[data-chat="user-input"]'),this.sendMessageBtn=this.appWindow.querySelector('[data-chat="send-message-btn"]'),this.messageArea=this.appWindow.querySelector('[data-chat="message-area"]'),this.usersOnlineList=this.appWindow.querySelector('[data-user-list="users-online"]'),this.clearUserInputBtn=this.appWindow.querySelector('[data-chat="clear-message-btn"]'),this.emojiBtn=this.appWindow.querySelector('[data-chat="emoji-btn"]'),this.emojiWrapper=this.appWindow.querySelector('[data-emoji="wrapper"]'),this.usersOnline=null,this.user=null,this.messages=null}start(e){this.MobileAdaptive.avatar(e),this.user=e,this.ws=new WebSocket("ws://localhost:9090"),this.userBtnsListeners(),this.ws.addEventListener("open",(()=>{const e={tag:"user connect",nickname:this.user.nickname,avatar:this.user.avatar,date:this.getThisDate()};this.ws.send(JSON.stringify(e))})),this.ws.addEventListener("message",(e=>{const i=JSON.parse(e.data);if("user connect"===i.tag)this.setUsersOnline(i),this.showAllMessages(i),this.messageArea.scrollTop=this.messageArea.scrollHeight;else if("user disconect"===i.tag){const e=`<div class="message-area__connect-new-user">\n                    <span class="connect-new-user__text">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ${i.userOut.nickname} Ğ¿Ğ¾ĞºĞ¸Ğ½ÑƒĞ» Ñ‡Ğ°Ñ‚ Ğ² ${this.getThisDate()}</span>\n                </div>`;this.messageArea.insertAdjacentHTML("beforeend",e),this.usersOnlineList.querySelector(`[data-user-id="${i.userOut.id}"]`).remove(),this.messageArea.scrollTop=this.messageArea.scrollHeight}else"user message"===i.tag&&(this.user.nickname===i.userNickname?(this.messageArea.insertAdjacentHTML("beforeend",t.setYouMessageHtml(i)),this.messageArea.scrollTop=this.messageArea.scrollHeight):(this.messageArea.insertAdjacentHTML("beforeend",t.setMessageHtml(i)),this.messageArea.scrollTop=this.messageArea.scrollHeight))})),this.ws.addEventListener("close",(e=>{const i={tag:"system message",nickname:this.user.nickname,avatar:this.user.avatar,date:this.getThisDate()};this.ws.send(JSON.stringify(i))}))}userBtnsListeners(){this.sendMessageBtn.addEventListener("click",(()=>{this.sendMessage()})),this.userInput.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),this.sendMessage())})),this.clearUserInputBtn.addEventListener("click",(()=>{this.userInput.value=""})),null!==this.emojiWrapper&&(this.emojiWrapper.innerHTML=t.setEmojiWindow(),this.emojiBtn.addEventListener("click",(()=>{this.emojiWrapper.classList.toggle("hidden")})),this.emojiWrapper.addEventListener("click",(e=>{e.target.classList.contains("emoji-window__item")&&(this.userInput.value+=e.target.innerHTML)})))}sendMessage(){if(""===this.userInput.value)return;const e={userNickname:this.user.nickname,userAvatar:this.user.avatar,date:this.getThisDate(),text:this.userInput.value,tag:"user message"};this.ws.send(JSON.stringify(e)),this.userInput.value=""}getThisDate(){const e=new Date;return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")} ${e.getDate().toString().padStart(2,"0")}.${(e.getMonth()+1).toString().padStart(2,"0")}.${e.getFullYear().toString()}`}setUsersOnline(e){this.usersOnline=e.clientsOnline,this.usersOnlineList.innerHTML="";for(let i in this.usersOnline)if(i===this.user.nickname){const s=`<div class="user" data-user-id="${e.clientsOnline[i].id}">\n                    <div class="user__avatar" data-user="avatar">\n                        <img class="user__avatar-image" src="${e.clientsOnline[i].avatar}">\n                    </div>\n                    <div class="user__name-box">\n                        <span class="user__name you-name">${i}</span>\n                    </div>\n                </div>`;this.usersOnlineList.insertAdjacentHTML("beforeend",s)}else{const s=`<div class="user" data-user-id="${e.clientsOnline[i].id}">\n                    <div class="user__avatar" data-user="avatar">\n                        <img class="user__avatar-image" src="${e.clientsOnline[i].avatar}">\n                    </div>\n                    <div class="user__name-box">\n                        <span class="user__name">${i}</span>\n                    </div>\n                </div>`;this.usersOnlineList.insertAdjacentHTML("beforeend",s)}}showAllMessages(e){this.messageArea.innerHTML="",e.actualMessages.forEach((e=>{if("system message"===e.tag){const i=`<div class="message-area__connect-new-user">\n                <span class="connect-new-user__text">${e.text}</span>\n            </div>`;this.messageArea.insertAdjacentHTML("beforeend",i)}else"user message"===e.tag&&(this.user.nickname===e.userNickname?(this.messageArea.insertAdjacentHTML("beforeend",t.setYouMessageHtml(e)),this.messageArea.scrollTop=this.messageArea.scrollHeight):(this.messageArea.insertAdjacentHTML("beforeend",t.setMessageHtml(e)),this.messageArea.scrollTop=this.messageArea.scrollHeight))}))}exitChat(){this.messageArea.innerHTML="",this.usersOnlineList.innerHTML="",this.userInput.value="",this.ws.close()}}new class{constructor(){this.appWindow=document.querySelector('[data-app="app"]'),this.exitChatBtn=this.appWindow.querySelector('[data-chat="exit-btn"]'),this.LogOrReg=new s(this.appWindow),this.Chat=new n(this.appWindow),this.user=null,this.modalWindows(),this.lastVisit()}modalWindows(){this.loginWindow()}loginWindow(){this.loginForm=document.forms["login-form"],this.loginForm.addEventListener("submit",(async e=>{e.preventDefault(),this.user=await this.LogOrReg.login(this.loginForm),this.user&&(this.Chat.start(this.user),this.saveState(),this.exitChat())})),this.loginForm["login-window-reg-btn"].addEventListener("click",(async()=>{this.html=await e.getModalWindow("/get-reg-window"),document.querySelector('[data-login="window-wrapper"]').remove(),this.appWindow.insertAdjacentHTML("afterbegin",this.html),this.regWindow()}))}regWindow(){this.regForm=document.forms["reg-form"],this.LogOrReg.regWindowAvatar(),this.regForm.addEventListener("submit",(async e=>{e.preventDefault();const i=await this.LogOrReg.registration(this.regForm);null!==i&&(this.user=i.newUser,this.user&&(this.Chat.start(this.user),this.saveState(),this.exitChat()))})),this.regForm["reg-window-cancel"].addEventListener("click",(async()=>{this.html=await e.getModalWindow("/get-login-window"),document.querySelector('[data-registartion="window-wrapper"]').remove(),this.appWindow.insertAdjacentHTML("afterbegin",this.html),this.loginWindow()}))}saveState(){localStorage.setItem("user",JSON.stringify({user:this.user,lastVisit:(new Date).getTime()}))}lastVisit(){const e=(new Date).getTime(),i=JSON.parse(localStorage.getItem("user"))||null;null!==i&&(e-i.lastVisit>864e5?localStorage.removeItem("user"):(this.user=i.user,document.querySelector('[data-login="window-wrapper"]').remove(),this.Chat.start(this.user),this.exitChat()))}exitChat(){const i=async()=>{this.Chat.exitChat(),localStorage.removeItem("user"),this.appWindow.insertAdjacentHTML("beforeend",await e.getModalWindow("/get-login-window")),this.modalWindows(),this.exitChatBtn.removeEventListener("click",i)};this.exitChatBtn.addEventListener("click",i)}}})();